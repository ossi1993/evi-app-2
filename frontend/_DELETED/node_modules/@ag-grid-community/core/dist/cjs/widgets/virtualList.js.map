{"version":3,"sources":["../../src/ts/widgets/virtualList.ts"],"names":[],"mappings":"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","file":"virtualList.js","sourcesContent":["import { Component } from './component';\nimport { Autowired } from '../context/context';\nimport { GridOptionsWrapper } from '../gridOptionsWrapper';\nimport { RefSelector } from './componentAnnotations';\nimport { ManagedFocusComponent } from './managedFocusComponent';\nimport { Constants } from '../constants';\nimport { _ } from '../utils';\n\nexport interface VirtualListModel {\n    getRowCount(): number;\n    getRow(index: number): any;\n}\n\nexport class VirtualList extends ManagedFocusComponent {\n    private model: VirtualListModel;\n    private renderedRows = new Map<number, { rowComponent: Component, eDiv: HTMLDivElement; }>();\n    private componentCreator: (value: any) => Component;\n    private rowHeight = 20;\n    private lastFocusedRow: number;\n\n    @Autowired('gridOptionsWrapper') gridOptionsWrapper: GridOptionsWrapper;\n    @RefSelector('eContainer') private eContainer: HTMLElement;\n\n    constructor(private readonly cssIdentifier = 'default') {\n        super(VirtualList.getTemplate(cssIdentifier));\n    }\n\n    protected postConstruct(): void {\n        this.addScrollListener();\n        this.rowHeight = this.getItemHeight();\n\n        super.postConstruct();\n    }\n\n    protected isFocusableContainer(): boolean {\n        return true;\n    }\n\n    protected focusInnerElement(fromBottom: boolean): void {\n        const rowCount = this.model.getRowCount();\n        this.focusRow(fromBottom ? rowCount - 1 : 0);\n    }\n\n    protected onFocusIn(e: FocusEvent): void {\n        super.onFocusIn(e);\n        const target = e.target as HTMLElement;\n\n        if (_.containsClass(target, 'ag-virtual-list-item')) {\n            this.lastFocusedRow = parseInt(target.getAttribute('aria-rowindex'), 10) - 1;\n        }\n    }\n\n    protected onFocusOut(e: FocusEvent) {\n        super.onFocusOut(e);\n\n        if (!this.getFocusableElement().contains(e.relatedTarget as HTMLElement)) {\n            this.lastFocusedRow = null;\n        }\n    }\n\n    protected handleKeyDown(e: KeyboardEvent) {\n        switch (e.keyCode) {\n            case Constants.KEY_UP:\n            case Constants.KEY_DOWN:\n            case Constants.KEY_TAB:\n                if (this.navigate(\n                    e.keyCode === Constants.KEY_UP ||\n                    (e.keyCode === Constants.KEY_TAB && e.shiftKey)\n                )) {\n                    e.preventDefault();\n                }\n                break;\n        }\n    }\n\n    private navigate(up: boolean): boolean {\n        if (!_.exists(this.lastFocusedRow)) { return false; }\n\n        const nextRow = this.lastFocusedRow + (up ? -1 : 1);\n\n        if (nextRow < 0 || nextRow >= this.model.getRowCount()) { return false; }\n\n        this.focusRow(nextRow);\n\n        return true;\n    }\n\n    public getLastFocusedRow(): number {\n        return this.lastFocusedRow;\n    }\n\n    public focusRow(rowNumber: number): void {\n        this.ensureIndexVisible(rowNumber);\n        window.setTimeout(() => {\n            const renderedRow = this.renderedRows.get(rowNumber);\n\n            if (renderedRow) {\n                renderedRow.eDiv.focus();\n            }\n        }, 10);\n    }\n\n    public getComponentAt(rowIndex: number): Component {\n        const comp = this.renderedRows.get(rowIndex);\n\n        return comp && comp.rowComponent;\n    }\n\n    private static getTemplate(cssIdentifier: string) {\n        return /* html */`\n            <div class=\"ag-virtual-list-viewport ag-${cssIdentifier}-virtual-list-viewport\">\n                <div class=\"ag-virtual-list-container ag-${cssIdentifier}-virtual-list-container\" ref=\"eContainer\"></div>\n            </div>`;\n    }\n\n    private getItemHeight(): number {\n        return this.gridOptionsWrapper.getListItemHeight();\n    }\n\n    public ensureIndexVisible(index: number): void {\n        const lastRow = this.model.getRowCount();\n\n        if (typeof index !== 'number' || index < 0 || index >= lastRow) {\n            console.warn('invalid row index for ensureIndexVisible: ' + index);\n            return;\n        }\n\n        const rowTopPixel = index * this.rowHeight;\n        const rowBottomPixel = rowTopPixel + this.rowHeight;\n        const eGui = this.getGui();\n\n        const viewportTopPixel = eGui.scrollTop;\n        const viewportHeight = eGui.offsetHeight;\n        const viewportBottomPixel = viewportTopPixel + viewportHeight;\n\n        const viewportScrolledPastRow = viewportTopPixel > rowTopPixel;\n        const viewportScrolledBeforeRow = viewportBottomPixel < rowBottomPixel;\n\n        if (viewportScrolledPastRow) {\n            // if row is before, scroll up with row at top\n            eGui.scrollTop = rowTopPixel;\n        } else if (viewportScrolledBeforeRow) {\n            // if row is below, scroll down with row at bottom\n            const newScrollPosition = rowBottomPixel - viewportHeight;\n            eGui.scrollTop = newScrollPosition;\n        }\n    }\n\n    public setComponentCreator(componentCreator: (value: any) => Component): void {\n        this.componentCreator = componentCreator;\n    }\n\n    public getRowHeight(): number {\n        return this.rowHeight;\n    }\n\n    public getScrollTop(): number {\n        return this.getGui().scrollTop;\n    }\n\n    public setRowHeight(rowHeight: number): void {\n        this.rowHeight = rowHeight;\n        this.refresh();\n    }\n\n    public refresh(): void {\n        if (this.model == null) { return; }\n\n        const rowCount = this.model.getRowCount();\n\n        this.eContainer.style.height = `${rowCount * this.rowHeight}px`;\n        this.eContainer.setAttribute('aria-rowcount', rowCount.toString());\n\n        // ensure height is applied before attempting to redraw rows\n        setTimeout(() => {\n            this.clearVirtualRows();\n            this.drawVirtualRows();\n        }, 0);\n    }\n\n    private clearVirtualRows() {\n        this.renderedRows.forEach((_, rowIndex) => this.removeRow(rowIndex));\n    }\n\n    private drawVirtualRows() {\n        const gui = this.getGui();\n        const topPixel = gui.scrollTop;\n        const bottomPixel = topPixel + gui.offsetHeight;\n        const firstRow = Math.floor(topPixel / this.rowHeight);\n        const lastRow = Math.floor(bottomPixel / this.rowHeight);\n\n        this.ensureRowsRendered(firstRow, lastRow);\n    }\n\n    private ensureRowsRendered(start: number, finish: number) {\n        // remove any rows that are no longer required\n        this.renderedRows.forEach((_, rowIndex) => {\n            if ((rowIndex < start || rowIndex > finish) && rowIndex !== this.lastFocusedRow) {\n                this.removeRow(rowIndex);\n            }\n        });\n\n        // insert any required new rows\n        for (let rowIndex = start; rowIndex <= finish; rowIndex++) {\n            if (this.renderedRows.has(rowIndex)) { continue; }\n\n            // check this row actually exists (in case overflow buffer window exceeds real data)\n            if (rowIndex < this.model.getRowCount()) {\n                const value = this.model.getRow(rowIndex);\n                this.insertRow(value, rowIndex);\n            }\n        }\n    }\n\n    private insertRow(value: any, rowIndex: number) {\n        const eDiv = document.createElement('div');\n\n        _.addCssClass(eDiv, 'ag-virtual-list-item');\n        _.addCssClass(eDiv, `ag-${this.cssIdentifier}-virtual-list-item`);\n        eDiv.setAttribute('aria-rowindex', (rowIndex + 1).toString());\n        eDiv.setAttribute('tabindex', '-1');\n\n        eDiv.style.height = `${this.rowHeight}px`;\n        eDiv.style.top = `${this.rowHeight * rowIndex}px`;\n\n        const rowComponent = this.componentCreator(value);\n\n        eDiv.appendChild(rowComponent.getGui());\n\n        this.eContainer.appendChild(eDiv);\n        this.renderedRows.set(rowIndex, { rowComponent, eDiv });\n    }\n\n    private removeRow(rowIndex: number) {\n        const component = this.renderedRows.get(rowIndex);\n\n        this.eContainer.removeChild(component.eDiv);\n        this.destroyBean(component.rowComponent);\n        this.renderedRows.delete(rowIndex);\n    }\n\n    private addScrollListener() {\n        this.addGuiEventListener('scroll', () => this.drawVirtualRows());\n    }\n\n    public setModel(model: VirtualListModel): void {\n        this.model = model;\n    }\n}\n"]}